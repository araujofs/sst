@startuml classes_completo

!define LIGHTYELLOW #FFFACD
!define LIGHTBLUE #E6F3FF
!define LIGHTGREEN #E6FFE6
!define LIGHTPINK #FFE6F0
!define LIGHTGRAY #F0F0F0

abstract Usuario {
  - nome: String
  - email: String
  - senha: String
  - foto: byte[]
  - status: Boolean
  + encerrar_sessao(): Boolean
  # autenticar(email: String, senha: String): Boolean
  + buscar_tentativas_acesso_falhas(): List<TentativaAcesso>
  + editar(usuario: Usuario): Boolean
  + reportar_erro(erro: ErroReportado): Boolean
}

abstract Gestor extends Usuario {
  + visualizar_status_sistema(): StatusSistema
  + visualizar_status_modulo(modulo: String): StatusModulo
}

abstract Associado extends Usuario {}

class Gerente extends Gestor {
  + criar_associado(associado: Associado): Boolean
  + editar_associado(associado: Associado): Boolean
  + apagar_associado(associado: Associado): Boolean
  + buscar_associado(nome: String): Associado
  + listar_associados(tipo: String): List<Associado>
  + desativar_associado(associado: Associado): Boolean
  + ativar_associado(associado: Associado): Boolean
}

class Cliente extends Associado {
  - tipo: String
  - razao_social: String
  - cpf: String
  - cnpj: String
  - cnpj_escritorio: String
}

class Contador extends Associado {}

class Administrador extends Gestor {
  + encerrar_sessao(usuario: Usuario): Boolean
  + criar_politica_senha(politica: PoliticaSenha): Boolean
  + editar_politica_senha(politica: PoliticaSenha): Boolean
  + apagar_politica_senha(politica: PoliticaSenha): Boolean
  + buscar_politica_senha(nome: String): Boolean
  + listar_politica_senha(): List<PoliticaSenha>
  + criar_usuario(usuario: Usuario): Boolean
  + editar_usuario(usuario: Usuario): Boolean
  + apagar_usuario(usuario: Usuario): Boolean
  + buscar_usuario(nome: String): Usuario
  + listar_usuarios(tipo: String): List<Usuario>
  + desativar_usuario(usuario: Usuario): Boolean
  + ativar_usuario(usuario: Usuario): Boolean
  + criar_rotina(rotina: RotinaBackup): Boolean
  + editar_rotina(rotina: RotinaBackup): Boolean
  + apagar_rotina(rotina: RotinaBackup): Boolean
  + buscar_rotina(nome: String): RotinaBackup
  + listar_rotinas(): List<RotinaBackup>
  + listar_logs(): List<Log>
  + editar_politica_log(politica: PoliticaLog): Boolean
}

class Tecnico extends Usuario {
  + listar_usuarios(): List<Usuario>
}

class Cliente {}


class PoliticaSenha {
  - nome: String
  - tempo_expiracao: Integer
  - tempo_aviso_previo_expiracao: Integer
  - usuarios_afetados: List<Usuario>
  + notificar_expiracao(): void
}

class TentativaAcesso {
  - datahora: Timestamp
  - dispositivo: String
}

class RotinaBackup {
  - nome: String
  - intervalo: Integer
  - destino: String
  - criptografia: String
  - compactacao: String
  - dados: List<String>
}

' so existe uma
class PoliticaLog {
  - tempo_armazenamento: Integer
  - detalhamento: String
  - categoria: String
}

class Log {
  - datahora: Timestamp
  - origem: String
  - nivel: String
  - mensagem: String
  - mensagem_detalhada: String
  - stack_trace: String
}

class ErroReportado {
  - descricao: String
  - arquivos: List<byte[]>
}

class StatusSistema {
  - datahora_atualizacao: Timestamp
  - tempo_medio_resposta: Integer
  - usuarios_ativos: List<Usuario>
  - cpu: Double
  - ram: Double
  - disco: Double
  - rede: Double
  - modulos_ativos: List<String>
}

class StatusModulo {
  - modulo: String
  - cpu: Double
  - ram: Double
  - disco: Double
  - uptime: Integer
  - latencia_media: Double
  - alertas_recentes: List<String>
}

Administrador ..> Usuario : "mantém"
Administrador ..> PoliticaLog : "configura"
Administrador ..> PoliticaSenha : "mantém"
Administrador ..> RotinaBackup : "mantém"
Administrador ..> Log : "visualiza"

Gerente ..> Associado : "mantém"

Gestor ..> StatusModulo : "visualiza"
Gestor ..> StatusSistema : "visualiza"

Usuario ..> TentativaAcesso : "visualiza"
Usuario ..> ErroReportado : "reporta"

' ===== MÓDULOS UNIFICADOS =====

package "Cálculo e Simulação" {
    
    class Simulacao LIGHTYELLOW {
        - nome: String
        - descricao: String
        - dataSimulacao: DateTime
        - versaoTabelas: String
        - desatualizada: Boolean
        --
        + salvar(): void
        + exportar(formato: String): File
        + marcarDesatualizada(): void
    }
    
    class DadosFinanceiros LIGHTYELLOW {
        - cnpj: String
        - razaoSocial: String
        - cnae: String
        - municipio: String
        - uf: String
        - receitaBrutaPeriodo: Decimal
        - rbt12: Decimal
        - folhaPagamento12m: Decimal
        - custosDespesas: Decimal
        --
        + validar(): Boolean
    }
    
    abstract class RegimeTributario <<Abstract>> LIGHTBLUE {
        # nomeRegime: String
        --
        + {abstract} calcular(dados: DadosFinanceiros): ResultadoCalculo
        + validarElegibilidade(dados: DadosFinanceiros): Boolean
    }
    
    class SimplesNacional extends RegimeTributario {
        --
        + calcular(dados: DadosFinanceiros): ResultadoCalculo
        + determinarAnexo(cnae: String): String
        + calcularFatorR(folha, rbt12: Decimal): Decimal
    }
    
    class LucroPresumido extends RegimeTributario {
        --
        + calcular(dados: DadosFinanceiros): ResultadoCalculo
    }
    
    class LucroReal extends RegimeTributario {
        --
        + calcular(dados: DadosFinanceiros): ResultadoCalculo
    }
    
    class ResultadoCalculo LIGHTGREEN {
        - regimeTributario: String
        - cargaTributariaTotal: Decimal
        - aliquotaEfetiva: Decimal
        - detalhamento: String
        - elegivel: Boolean
        --
        + getTotalTributos(): Decimal
    }
    
    class Tributo LIGHTPINK {
        - nome: String
        - baseCalculo: Decimal
        - aliquota: Decimal
        - valorFinal: Decimal
        --
        + calcular(): Decimal
    }
    
    class ComparadorRegimes LIGHTBLUE {
        --
        + comparar(dados: DadosFinanceiros): List<ResultadoCalculo>
        + identificarMelhorRegime(): String
    }
    
    class HistoricoSimulacao LIGHTPINK {
        - versao: Integer
        - dataVersao: DateTime
        - dadosAnteriores: JSON
        - dadosNovos: JSON
        --
        + salvar(): void
    }
}

package "Importação" {
    
    class ImportadorArquivo LIGHTBLUE {
        --
        + importar(arquivo: File): ResultadoImportacao
        + validarFormato(arquivo: File): Boolean
        + mapearColunas(arquivo: File): Map<String, String>
    }
    
    class ConsultaCNPJ LIGHTBLUE {
        --
        + consultar(cnpj: String): DadosCadastrais
        + validarCNPJ(cnpj: String): Boolean
    }
    
    class DadosCadastrais LIGHTYELLOW {
        - cnpj: String
        - razaoSocial: String
        - cnae: String
        - municipio: String
        - uf: String
        - situacaoCadastral: String
        --
        + isAtivo(): Boolean
    }
    
    class ResultadoImportacao LIGHTGREEN {
        - sucesso: Boolean
        - camposPreenchidos: Integer
        - erros: List<String>
        --
        + temErros(): Boolean
    }
}

package "Atualização de Legislação" {
    
    class GerenciadorTabelas LIGHTBLUE {
        --
        + atualizarTabela(tipo: String, dados: File): Boolean
        + obterTabelaVigente(tipo: String): TabelaTributaria
        + listarHistorico(tipo: String): List<HistoricoTabela>
    }
    
    class TabelaTributaria LIGHTYELLOW {
        - tipo: String
        - versao: String
        - dataVigencia: Date
        - baseLegal: String
        - dados: JSON
        - ativa: Boolean
        --
        + validar(): Boolean
        + obterAliquota(parametro: String): Decimal
        + obterFaixa(valor: Decimal): Map<String, Object>
    }
    
    class GerenciadorAliquotas LIGHTBLUE {
        --
        + cadastrarISS(municipio: String, aliquota: Decimal): Boolean
        + cadastrarICMS(uf: String, aliquota: Decimal): Boolean
        + consultarAliquota(local: String, tipo: String): Decimal
    }
    
    class AliquotaLocal LIGHTYELLOW {
        - tipo: String
        - local: String
        - aliquota: Decimal
        - dataVigencia: Date
        - baseLegal: String
        - ativa: Boolean
        --
        + isVigente(): Boolean
    }
    
    class NotificadorLegislacao LIGHTBLUE {
        --
        + notificar(mudanca: String): void
        + identificarSimulacoesImpactadas(tabelaId: UUID): List<Simulacao>
        + marcarSimulacoesDesatualizadas(tabelaId: UUID): void
    }
    
    class HistoricoTabela LIGHTPINK {
        - versaoAnterior: String
        - versaoNova: String
        - dataAtualizacao: DateTime
        - baseLegal: String
        --
        + restaurar(): TabelaTributaria
    }
}

package "Validação" {
    
    class ValidadorDados LIGHTGRAY {
        --
        + validar(dados: DadosFinanceiros, regime: String): List<ErroValidacao>
        + validarObrigatorios(dados: DadosFinanceiros): List<ErroValidacao>
        + validarTipos(dados: DadosFinanceiros): List<ErroValidacao>
        + validarCNAE(cnae: String): ErroValidacao
        + verificarLimites(dados: DadosFinanceiros, regime: String): ErroValidacao
    }
    
    class ErroValidacao LIGHTGRAY {
        - campoInvalido: String
        - mensagemErro: String
        - tipoErro: String
        --
        + getDescricao(): String
    }
}

' ===== RELACIONAMENTOS - CÁLCULO =====

Simulacao "1" *-- "1" DadosFinanceiros : contém
Simulacao "1" --> "1..*" RegimeTributario : simula
RegimeTributario ..> ResultadoCalculo : produz
ResultadoCalculo "1" *-- "1..*" Tributo : contém
Simulacao "1" --> "0..*" HistoricoSimulacao : possui
ComparadorRegimes ..> RegimeTributario : usa
ComparadorRegimes ..> ResultadoCalculo : gera

' ===== RELACIONAMENTOS - IMPORTAÇÃO =====

ImportadorArquivo ..> ResultadoImportacao : retorna
ImportadorArquivo ..> DadosFinanceiros : preenche
ConsultaCNPJ ..> DadosCadastrais : retorna
DadosCadastrais ..> DadosFinanceiros : preenche

' ===== RELACIONAMENTOS - ATUALIZAÇÃO =====

GerenciadorTabelas --> TabelaTributaria : gerencia
GerenciadorTabelas --> HistoricoTabela : registra
GerenciadorTabelas ..> NotificadorLegislacao : notifica
GerenciadorAliquotas --> AliquotaLocal : gerencia
TabelaTributaria "1" --> "0..*" HistoricoTabela : possui
NotificadorLegislacao ..> Simulacao : marca desatualizada

' ===== RELACIONAMENTOS - VALIDAÇÃO =====

Simulacao ..> ValidadorDados : valida
ValidadorDados ..> ErroValidacao : retorna

' ===== RELACIONAMENTO inportante: REGIMES CONSULTAM TABELAS =====

SimplesNacional ..> TabelaTributaria : "consulta tabelas\nSimples Nacional"
LucroPresumido ..> TabelaTributaria : "consulta tabelas\nPresunção"
LucroReal ..> TabelaTributaria : "consulta tabelas\nIRPJ/CSLL/PIS/COFINS"

SimplesNacional ..> AliquotaLocal : "consulta ISS"
LucroPresumido ..> AliquotaLocal : "consulta ISS/ICMS"
LucroReal ..> AliquotaLocal : "consulta ISS"

' ===== RELACIONAMENTOS - ADMINISTRADOR ATUALIZA =====

Administrador ..> GerenciadorTabelas : usa
Administrador ..> GerenciadorAliquotas : usa


note right of SimplesNacional
  Durante o cálculo, consulta DIRETAMENTE:
  - TabelaTributaria (tipo: SIMPLES_NACIONAL)
    para obter anexos, faixas e alíquotas
  - AliquotaLocal (tipo: ISS) para
    obter alíquota municipal
end note

note right of GerenciadorTabelas
  Usado apenas pelo Administrador para:
  - Criar/Atualizar/Deletar tabelas
  - Quando atualizado, dispara
    NotificadorLegislacao que marca
    Simulações antigas como desatualizadas
end note

note bottom of TabelaTributaria
  Armazena as regras tributárias:
  - Simples Nacional (anexos e faixas)
  - Presunção (alíquotas por CNAE)
  - IRPJ/CSLL (alíquotas básicas)
  - PIS/COFINS (alíquotas cumulativo/não-cumulativo)
end note

@enduml